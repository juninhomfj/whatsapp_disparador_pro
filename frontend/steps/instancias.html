<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Inst칙ncias</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <style>
    .instancia-card {
      border: 2px solid #eee;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      transition: box-shadow 0.2s;
      cursor: pointer;
    }
    .instancia-foto {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 16px;
      border: 2px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="card p-4">
      <h2>游님 Minhas Inst칙ncias WhatsApp</h2>
      <div id="instancias"></div>
      <button class="btn btn-outline-primary mt-3" onclick="criarInstancia()">+ Nova Inst칙ncia</button>
    </div>
  </div>
  <script>
    async function carregarInstancias() {
      const r = await fetch("http://localhost:3000/api/whatsapp/instances");
      const instancias = await r.json();
      const div = document.getElementById("instancias");
      div.innerHTML = "";
      if (!instancias.length) {
        div.innerHTML = "<div class='alert alert-warning'>Nenhuma inst칙ncia conectada.</div>";
        return;
      }
      instancias.forEach(inst => {
        div.innerHTML += `
          <div class="instancia-card">
            <img src="${inst.fotoPerfil || '../img/whatsapp.png'}" class="instancia-foto" alt="Foto">
            <div>
              <b>${inst.nome || inst.numero || 'Sem n칰mero'}</b><br>
              <small>${inst.status === 'connected' ? 'Conectado' : 'Desconectado'}</small>
            </div>
            <button class="btn btn-danger btn-sm ms-auto" onclick="removerInstancia('${inst._id}')">Remover</button>
          </div>
        `;
      });
    }

    async function criarInstancia() {
      const r = await fetch("http://localhost:3000/api/whatsapp/instances", { method: "POST" });
      const data = await r.json();
      if (data.qr) {
        // Exibe o QR code para o usu치rio escanear
        const qrWin = window.open("", "_blank", "width=400,height=400");
        qrWin.document.write(`<img src="${data.qr}" style="width:100%">`);
        alert("Escaneie o QR code na nova janela com o WhatsApp!");
      } else {
        alert("Erro ao criar inst칙ncia");
      }
      setTimeout(carregarInstancias, 3000); // Aguarda conex칚o e recarrega
    }

    async function removerInstancia(id) {
      if (!confirm("Deseja remover esta inst칙ncia?")) return;
      await fetch(`http://localhost:3000/api/whatsapp/instances/${id}`, { method: "DELETE" });
      carregarInstancias();
    }

    carregarInstancias();
  </script>
</body>
</html>